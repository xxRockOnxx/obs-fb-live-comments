<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="This is for Facebook users who do not want to create a Facebook Page and share their stream publicly just to show their comments feed on their stream.">
    <title>OBS Personal Facebook Live Comments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            padding: 16px;
            font-size: 20px;
            line-height: 2;
            max-width: 896px;
            margin-left: auto;
            margin-right: auto;
        }

        a {
            color: #0EA5E9;
            text-decoration: none;
        }

        blockquote {
            padding: 0 1em;
            color: #525252;
            border-left: .25em solid #dfe2e5;
            margin-left: 0;
            margin-right: 0;
        }

        code {
            padding: .2em .4em;
            margin: 0;
            background: rgba(27,31,35,.05);
        }

        pre {
            padding: 16px;
            overflow: auto;
            line-height: 1.45;
            background: #f6f8fa;
            user-select: none;
            cursor: pointer;
        }

        pre code {
            background: initial;
            padding: 0;
        }

        ul {
            padding-left: 2em;
        }

        li {
            margin-top: .25em;
        }

        h1,
        h2 {
            padding-bottom: .3em;
            border-bottom: 2px solid #D4D4D4;
        }
    </style>
</head>
<body id="markdown">

<h1 id="obs-facebook-live-comments">OBS Personal Facebook Live Comments</h1>

<p>This is for Facebook users who do not want to create a Facebook Page and share their stream publicly just to show
    their comments feed on their stream.</p>

    <p><strong>Use this at your own Risk</strong>.</p>

<p>I attempted making a proper app that allows people to login using their Facebook account and simply copying a link to
    their Browser Source (<a href="https://github.com/xxRockOnxx/obs-fb-live-comments/issues/2">see more here</a>)
    similar to TidyLabs if you are DLive user, but unfortunately Facebook did not approve the app.</p>

<p>The app requires approval from Facebook so it can access your Live Streams but according to the <a
    href="https://developers.facebook.com/docs/facebook-login/permissions/#reference-user_videos">allowed usages</a>:</p>

<blockquote>
    <p style="font-size: 1.5rem;"><strong>user_videos</strong></p>
    <p>Requires App Review</p>
    <p>The <code>user_videos</code> permission allows your app to read a list of videos uploaded by a user.</p>
    <p>Allowed Usage:</p>
    <ul>
        <li>Display a person’s videos on a TV via a set-top box or display their videos in a digital photo frame.</li>
        <li>Provide people with the ability to edit or create new video content using existing videos.</li>
        <li>Provide people with the ability to display their video with owners within their app, like in dating or
            social apps.
        </li>
    </ul>
</blockquote>

<p>Hence, the disapproval. If I have to point it out to you, what we want is not part of the Allowed Usage.</p>
<p><strong>BUT</strong>, “Where there is a will, there is a way”, so here you go.</p>

<h2 id="instructions">Instructions (Updated Apr 04, 2021; Better code that doesn't rely on DOM)</h2>

<div style="position: relative; padding-top: 56.25%;">
    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
        <iframe width="100%" height="100%" src="https://www.youtube.com/embed/77Ixvbi0zOc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
</div>

<ol style="list-style-type: decimal;">
    <li
      >Open up OBS with remote debugging. See <a href="#how-to-start-obs-with-remote-debugging">how to</a>.
    </li>

    <li>
        Add a Browser Source.<br/>
        If this is your first time, put <code>https://facebook.com</code> as the address.
    </li>

    <li>
      Visit OBS’s browser on your browser by going to <a href="http://localhost:9222/">http://localhost:9222</a> (or whatever port you put in).
    </li>

    <li>
      Click the link to that corresponds to the Browser Source you added. <br/>
      Each Browser Source in OBS will show up as a link in here.
    </li>

    <li>
      If this was your first time, Log In to Facebook because later on we will need to go to your stream's direct link.
    </li>

    <li>
      Copy the <a href="#css-code">CSS code</a> and paste it in the CSS textboxt of OBS Browser Source dialog box. <br/>
    </li>

    <li>
      Start your stream. Both in OBS and Facebook.
    </li>

    <li>
      Copy the direct link to your stream by Right-clicking on the "Just Now" under your name, and selecting "Copy link address".
    </li>

    <li>
      Visit your Stream in OBS Browser by either pasting it in OBS Browser's address bar i.e in <code>http://localhost:9222 (or whatever port you put in)</code>
    </li>

    <li>
      Click the Network tab and filter by "WS" (which means WebSocket).
    </li>

    <li>
      If you did not see anything in there, just refresh the OBS Browser. There's a refresh button in there.
    </li>

    <li>
      Click the "Initiator" so we can see the code that creates the realtime connection Facebook uses.
    </li>

    <li>
      Click the Pretty Print button at the bottom. It looks like a pair of brackets "{}".
    </li>

    <li>
      Add a breakpoint to the line. To confirm, it has the "new WebSocket" on that line.<br/>
      This will stop the code execution so we can execute the code we need first.
    </li>

    <li>
      Refresh OBS Browser again.
    </li>

    <li>
      Paste the <a href="#step-1-code">Step 1 code</a>.
    </li>

    <li>
      Continue the code execution so the webpage works.<br>
      Go to "Sources" tab and click the blue play button.<br>
      If it paused again, which happens sometimes, just click it again.
    </li>

    <li>
      Paste the <a href="#step-2-code">Step 2 code</a>.
    </li>

    <li>
      Done. Enjoy.
    </li>
</ol>

<h2>The Codes</h2>

<h3 id="css-code">CSS Code</h3>

<p>You can customize this if you know CSS.</p>

<pre class="copy-code"><code class="language-css">html {
  font-size: 16px;
}

body {
  height: 100vh;
}

#obs-fb-live-comments {
  list-style-type: none;

  display: flex;
  flex-direction: column;
  justify-content: flex-end;

  min-height: 100%;

  margin: 16px;
  overflow: hidden;
}

.message + .message {
  margin-top: 8px;
}

.message {
  border-radius: 12px;
  padding: 12px;
  background: #424242;
  color: #eee;
}

.message__author {
  font-weight: 600;
}

.message__body {
  font-size: 18px;
}</code></pre>

<h3 id="step-1-code">Step 1 Code</h3>

<pre class="copy-code"><code class="language-javascript">// Copy the original WebSocket function
// because we are going to override it.
const NativeWebSocket = window.WebSocket;

// Override original WebSocket so we can
// have a reference to the instance FB will use.
// They only use 1 connection (at least based on my experience).
// Can't find a way to make a connection to them manually.
window.WebSocket = function(...args) {
  const instance = new NativeWebSocket(...args);
  window.chat = instance;
  return instance;
}
</code></pre>

<h3 id="step-2-code">Step 2 Code</h3>

<pre class="copy-code"><code class="language-javascript">// Remove all elements in the page.
Array.prototype.forEach.call(document.body.children, function (el) {
  document.body.removeChild(el);
})

// Create our chat container
const ID = 'obs-fb-live-comments';
const containerElement = document.createElement('div');
containerElement.id = ID;

// Put our container to the page.
document.body.appendChild(containerElement);

// Make the webpage transparent and hide scrollbar
// so we can use it as overlay in OBS.
document.documentElement.style.setProperty('overflow', 'hidden', 'important');
document.body.style.setProperty('overflow', 'hidden', 'important');
document.body.style.setProperty('background', 'rgba(0,0,0,0)', 'important');

function createCommentElement({ author, message }) {
  const commentEl = document.createElement('div');
  commentEl.classList.add('message');

  const authorEl = document.createElement('div');
  authorEl.classList.add('message__author');
  authorEl.textContent = author;

  const bodyEl = document.createElement('div')
  bodyEl.classList.add('message__body')
  bodyEl.textContent = message;

  commentEl.appendChild(authorEl);
  commentEl.appendChild(bodyEl);

  return commentEl;
}

// Listen for new comments and do stuff
window.chat.addEventListener('message', evt => {
  const decoder = new TextDecoder("utf-8");
  const rootJson = decoder.decode(evt.data);

  // The message seems to container a "topic" name at the start.
  // I think it is MQTT stuff and I do not know how to work with it
  // especially in the browser AND without loading external scripts.
  const normalizedJson = rootJson.slice(rootJson.indexOf('{'));

  try {
    var _parsedJson$frames, _parsedData$data, _parsedData$data$live;

    const parsedJson = JSON.parse(normalizedJson);
    const rootData = (_parsedJson$frames = parsedJson.frames) === null || _parsedJson$frames === void 0 ? void 0 : _parsedJson$frames[0].data;

    if (!rootData) {
      return;
    }

    console.log("Has rootData. Parsing data now.");
    const parsedData = JSON.parse(atob(rootData.data));

    if (!parsedData) {
      return;
    }

    console.log("Has parsedData. Parsing comment now.");
    const comment = parsedData === null || parsedData === void 0 ? void 0 : (_parsedData$data = parsedData.data) === null || _parsedData$data === void 0 ? void 0 : (_parsedData$data$live = _parsedData$data.live_video_comment_create_subscribe) === null || _parsedData$data$live === void 0 ? void 0 : _parsedData$data$live.comment;

    if (!comment) {
      return;
    }

    console.log('Has a comment.', {
      comment
    });

    console.log({
      author: comment.author.name,
      message: comment.body.text
    });

    // Insert comment element to the container
    containerElement.appendChild(createCommentElement({
      author: comment.author.name,
      message: comment.body.text
    }));

    // Scroll to the last comment
    document.body.scrollTop = document.body.scrollHeight;
  } catch (e) {
    // not the data we want or just dont crash at all whatever happens.
  }
});
</code></pre>

<h2 id="how-to-start-obs-with-remote-debugging">How To Start OBS With Remote Debugging</h2>
<h3 id="windows">Windows</h3>
<ul>
    <li>Edit or Create another desktop shortcut to OBS.</li>
    <li>Add <code>--remote-debugging-port=9222</code> at the end of the Target. It doesn’t have to be port 9222.</li>
</ul>
<h3 id="linux">Linux</h3>
<ul>
    <li>Open up a terminal and type:</li>
</ul>
<pre class=" language-bash"><code class="prism  language-bash">obs --remote-debugging-port<span
    class="token operator">=</span>9222 <span class="token punctuation">(</span>or whatever port you like<span
    class="token punctuation">)</span>
</code></pre>

<h2 id="issues-or-suggestions">Issues or Suggestions</h2>

<p>
    Head over to this website's <a href="https://github.com/xxRockOnxx/obs-fb-live-comments/">GitHub repository</a> and open an Issue.<br/>
    Or just comment in the YouTube video.
</p>

<script>
    const codeEl = document.getElementById('js-code')

    document.querySelectorAll('.copy-code').forEach((el) => {
      el.addEventListener('click', evt => {
          navigator.clipboard.writeText(el.textContent)
          window.alert('Code copied to clipboard!')
      })
    });
</script>

<!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
  (function (f, a, t, h, o, m) {
    a[h] =
      a[h] ||
      function () {
        (a[h].q = a[h].q || []).push(arguments);
      };
    (o = f.createElement("script")), (m = f.getElementsByTagName("script")[0]);
    o.async = 1;
    o.src = t;
    o.id = "fathom-script";
    m.parentNode.insertBefore(o, m);
  })(document, window, "//lemuel-fathom.herokuapp.com/tracker.js", "fathom");
  fathom("set", "siteId", "BYSKE");
  fathom("trackPageview", {
    path: "/",
  });
</script>
<!-- / Fathom -->
</body>
</html>
